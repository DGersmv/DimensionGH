ПЛАН РАБОТ ДЛЯ Dimension_Gh (на базе BrowserReplInt)

ЦЕЛЬ V1:
Сделать add-on Dimension_Gh, который:
- Корректно собирается под AC 27.
- Имеет своё имя, GUID'ы и ресурсные ID.
- Слушает HTTP порт, который автоматически назначается Archicad'ом (получается через ACAPI_Command_GetHttpConnectionPort()).
- Принимает из Grasshopper пары точек и создаёт между ними линейные размеры.
- Порт отображается в браузерной палитре через функцию GetHttpPort() (уже реализовано).

ОСНОВА:
Используем готовую реализацию создания размеров из BrowserReplInt:
- MarkupHelper::CreateDimensionBetweenPoints() - базовая функция создания размера между двумя точками

--------------------------------------------------
ЭТАП 1. ИЗУЧЕНИЕ И АДАПТАЦИЯ КОДА ИЗ BrowserReplInt
--------------------------------------------------

1. Изучить реализацию создания размеров в BrowserReplInt:
   - Файл: C:\...\BrowserReplInt\Src\MarkupHelper.cpp
   - Функция: CreateDimensionBetweenPoints() - создание размера между двумя точками
   - Понять структуру API_Dimension и API_DimElem

2. Скопировать необходимые функции в Dimension_Gh:
   - Создать файл Src/DimensionHelper.hpp и DimensionHelper.cpp
   - Перенести функцию CreateDimensionBetweenPoints() как базовую
   - Адаптировать под наш стиль кода (namespace DimensionHelper)
   - Убрать зависимости от MarkupHelper (если есть специфичные для разметки)

--------------------------------------------------
ЭТАП 2. РЕАЛИЗАЦИЯ DIMENSIONHELPER
--------------------------------------------------

3. Создать DimensionHelper.hpp:
   ```cpp
   namespace DimensionHelper {
       // Создать линейный размер между двумя точками
       bool CreateLinearDimension(
           const API_Coord& pt1, 
           const API_Coord& pt2,
           const GS::UniString& layerName = GS::EmptyUniString,
           const GS::UniString& styleName = GS::EmptyUniString,
           const GS::UniString& textOverride = GS::EmptyUniString
       );
   }
   ```

4. Реализовать DimensionHelper.cpp:
   - Адаптировать CreateDimensionBetweenPoints из BrowserReplInt
   - Добавить поддержку layerName, styleName, textOverride (опционально)
   - Упростить: если layerName/styleName не указаны, использовать значения по умолчанию из Archicad

5. Протестировать базовую функцию:
   - Проверить, что CreateLinearDimension() создаёт размер корректно
   - Проверить работу с разными параметрами (слой, стиль, текст)

--------------------------------------------------
ЭТАП 3. ИНТЕГРАЦИЯ С JSON-ПРОТОКОЛОМ (BRIDGE)
--------------------------------------------------

6. Обновить Bridge.cpp для работы с DimensionHelper:
   - Команда "Ping" - уже реализована, оставить для тестирования соединения
   - Команда "CreateLinearDimension":
     * Принять payload с двумя точками:
       {
         "point1": {"x": ..., "y": ..., "z": ...},
         "point2": {"x": ..., "y": ..., "z": ...},
         "layer": "..." (опционально),
         "style": "..." (опционально),
         "text": "..." (опционально)
       }
     * Вызвать DimensionHelper::CreateLinearDimension()
     * Вернуть результат создания

7. Обновить формат JSON-ответов:
   - CreateLinearDimension возвращает:
     {
       "ok": true,
       "result": {
         "created": true,
         "guid": "..." (опционально, если удалось получить GUID созданного размера)
       }
     }
   - При ошибке:
     {
       "ok": false,
       "error": "описание ошибки"
     }

--------------------------------------------------
ЭТАП 4. ИНТЕГРАЦИЯ С API_ADDONCOMMAND
--------------------------------------------------

8. Реализовать CreateLinearDimensionCommand::Execute():
   - Принять параметры из GS::ObjectState
   - Извлечь point1, point2, layer, style, text
   - Вызвать DimensionHelper::CreateLinearDimension()
   - Вернуть результат в формате GS::ObjectState

9. Протестировать команду через API_AddOnCommand:
   - Использовать тестовый скрипт или другой аддон
   - Проверить, что команда выполняет создание размера
   - Проверить обработку ошибок

--------------------------------------------------
ЭТАП 5. HTTP СЕРВЕР ДЛЯ GRASSHOPPER
--------------------------------------------------

10. Проверить HTTP сервер (должен быть уже реализован):
    - Порт назначается автоматически Archicad'ом через ACAPI_Command_GetHttpConnectionPort()
    - Получить порт можно через команду GetPort (уже реализована)
    - Endpoint: POST / - принимает JSON запросы
    - Формат запроса/ответа совпадает с Bridge::HandleJsonRequest()

11. Интегрировать HTTP сервер с Bridge:
    - HTTP запрос → JSON строка → Bridge::HandleJsonRequest()
    - Результат → JSON строка → HTTP ответ

12. Протестировать через HTTP:
    - Отправить POST запрос с {"command": "Ping"}
    - Отправить POST запрос с {"command": "CreateLinearDimension", "payload": {"point1": {...}, "point2": {...}}}

--------------------------------------------------
ЭТАП 6. GRASSHOPPER КОМПОНЕНТЫ
--------------------------------------------------

13. Главная нода Dim_CreateDimension (основная):
    - Входы:
      * Port (int) - номер порта HTTP
      * PointPairs (List<PointPair>) - список пар точек для создания размеров
      * Run (bool) - выполнить создание
    - Функционал:
      * Проверка подключения к Archicad (Ping)
      * Для каждой пары точек: отправка CreateLinearDimension в Archicad
      * Создание визуализации в Rhino для каждой пары
      * Возврат статуса создания для каждой пары
    - Выходы:
      * Connected (bool) - статус подключения
      * Success (List<bool>) - успешность создания для каждой пары
      * Messages (List<string>) - сообщения для каждой пары

14. Вспомогательные ноды для подготовки пар точек:
    - Dim_FromLines - извлекает пары точек из двух линий:
      * Line1, Line2 - входные линии
      * Возвращает: PointPair (Point1 из Line1, Point2 из Line2)
    - Dim_FromCurves - извлекает пары точек из кривых (для будущего расширения)
    - Dim_FromPoints - просто принимает две точки и формирует пару
    - Dim_FromSelection - извлекает точки из выделенных объектов (для будущего расширения)

15. Протестировать полный цикл:
    - Запустить Archicad с Dimension_Gh
    - Запустить Grasshopper
    - В GH: Dim_FromLines → получить пару точек
    - В GH: Dim_CreateDimension → подключиться и создать размеры
    - Проверить создание размеров в Archicad и визуализацию в Rhino

--------------------------------------------------
ЭТАП 7. ДОРАБОТКА И ОПТИМИЗАЦИЯ
--------------------------------------------------

16. Обработка ошибок:
    - Добавить проверки валидности входных данных (точки не совпадают, координаты валидны)
    - Корректные сообщения об ошибках в JSON-ответах
    - Логирование ошибок (опционально)

17. Оптимизация (если нужно):
    - Батчинг создания размеров (создание нескольких за раз из одного запроса)
    - Валидация координат перед созданием

18. Документация:
    - Обновить README.md с описанием API
    - Добавить примеры JSON-запросов для CreateLinearDimension
    - Описать формат данных для Grasshopper

--------------------------------------------------
ТЕКУЩИЙ СТАТУС:
--------------------------------------------------

✅ Этап 1: Переименование и уникальные идентификаторы (завершено)
✅ Этап 2: Сборка "пустого" Dimension_Gh (завершено)
✅ Этап 3: Выделение модуля моста (Bridge) (завершено)
✅ GetPort команда: реализована (получение порта от Archicad через ACAPI_Command_GetHttpConnectionPort)
✅ Ping команда: реализована
✅ DimensionHelper: реализован (на базе BrowserReplInt)
✅ Bridge.cpp: обновлен для обработки point1 и point2
✅ CreateLinearDimensionCommand: реализована (с поддержкой привязки к элементам через hotspots)
✅ Hotspot команды: реализованы (CreateHotspot, UpdateHotspot, DeleteHotspot, DeleteAllHotspots)
✅ PointPair: обновлен (добавлены поля для Rhino Point GUID и Archicad Hotspot GUID, отслеживание изменений координат)
✅ DimCreateDimensionComponent: обновлен (создает hotspots перед созданием размеров, режим обновления)
✅ Режим обновления: добавлен параметр "Update" для обновления существующих hotspots при изменении координат
✅ Очистка hotspots: реализована при закрытии соединения (в FreeData)

СЛЕДУЮЩИЕ ШАГИ:
1. Протестировать создание hotspots и привязку размеров
2. Реализовать логику обновления hotspots при изменении координат точек в Rhino
3. Протестировать полный цикл работы с синхронизацией

--------------------------------------------------
ИСПРАВЛЕННЫЕ ОШИБКИ:
--------------------------------------------------

1. **C2039: "ToDouble": не является членом "GS::UniString"**
   - Исправлено: заменено на `std::atof(numStr.ToCStr().Get())`
   - Файл: `Src/Bridge.cpp`

2. **C2039: "z": не является членом "API_Coord"**
   - Исправлено: удалены все ссылки на `coord.z`, `pt1.z`, `pt2.z` (API_Coord - 2D структура)
   - Файлы: `Src/Bridge.cpp`, `Src/DimensionCommands.cpp`, `Src/DimensionHelper.cpp`

3. **CS0103: The name 'UnitSystem' does not exist**
   - Исправлено: изменено на `Rhino.UnitSystem`
   - Файл: `DimensionGH_Gh/Components/DimCreateFromLinesComponent.cs`

4. **CS1061: 'TextEntity' does not contain a definition for 'Height'**
   - Исправлено: удалена строка `text.Height = textHeight;`
   - Файл: `DimensionGH_Gh/Components/DimCreateFromLinesComponent.cs`

5. **CS0618: 'AnnotationBase.Text' is obsolete**
   - Исправлено: изменено `text.Text` на `text.PlainText`
   - Файл: `DimensionGH_Gh/Components/DimCreateFromLinesComponent.cs`

6. **C2065: 'APINullGuid': undeclared identifier**
   - Исправлено: изменено на `APINULLGuid` (правильное имя константы)
   - Файлы: `Src/Bridge.cpp`, `Src/DimensionCommands.cpp`, `Src/DimensionHelper.cpp`

7. **C3861: 'APIGuid_IsNull': identifier not found**
   - Исправлено: заменено на `guid != APINULLGuid`
   - Файлы: `Src/Bridge.cpp`, `Src/DimensionCommands.cpp`, `Src/DimensionHelper.cpp`

8. **C2065: 'APIMemoMask_Hotspots': undeclared identifier**
   - Исправлено: используется `ACAPI_Element_GetHotspots()` вместо `ACAPI_Element_GetMemo()`
   - Файл: `Src/DimensionHelper.cpp`

9. **C2039: 'hotspots': is not a member of 'API_ElementMemo'**
   - Исправлено: используется `GS::Array<API_ElementHotspot>` из `ACAPI_Element_GetHotspots()`
   - Файл: `Src/DimensionHelper.cpp`

10. **CS0246: The type or namespace name 'Guid' could not be found**
    - Исправлено: добавлен `using System;` в начало файла
    - Файл: `DimensionGH_Gh/Protocol/PointPair.cs`

11. **C2664: 'ACAPI_Element_Delete': cannot convert argument**
    - Исправлено: `ACAPI_Element_Delete()` принимает `GS::Array<API_Guid>`, а не указатель на header
    - Исправлено: создается массив GUID перед вызовом
    - Файл: `Src/DimensionCommands.cpp` (строки 398, 747)

12. **C2039: 'z': is not a member of 'API_Coord'**
    - Исправлено: удалена строка `hotspot.hotspot.pos.z = 0.0;` (API_Coord - 2D структура)
    - Файл: `Src/DimensionCommands.cpp` (строка 516)

13. **C3861: 'ACAPI_Element_Modify': identifier not found**
    - Исправлено: заменено на `ACAPI_Element_Change(&element, &mask, nullptr, 0, true)`
    - Файл: `Src/DimensionCommands.cpp` (строка 656)

14. **C2065: 'API_ElementMask': undeclared identifier**
    - Исправлено: используется `API_Element mask` (не `API_ElementMask`), mask имеет тот же тип, что и элемент
    - Файл: `Src/DimensionCommands.cpp` (строка 653)

15. **C2039: 'API_Hotspot_PosID': is not a member of 'API_HotspotType'**
    - Исправлено: используется просто `pos` (имя поля в структуре API_HotspotType), а не `API_Hotspot_PosID`
    - Файл: `Src/DimensionCommands.cpp` (строка 656)

16. **Размеры не привязываются к hotspots - создаются новые размеры при обновлении**
    - Проблема: размеры привязывались к элементам, а не к hotspot элементам, поэтому при обновлении hotspots создавались новые размеры
    - Исправлено:
        - Изменена сигнатура `CreateLinearDimension` для приема hotspot GUID напрямую
        - Размеры теперь привязываются к hotspot элементам (API_HotspotID) вместо элементов
        - При обновлении hotspots размеры автоматически обновляются, так как привязаны к hotspot элементам
        - Добавлена кнопка Update в Grasshopper компонент
        - В режиме Update обновляются только hotspots, новые размеры не создаются
    - Файлы:
        - `Src/DimensionHelper.hpp` - добавлены параметры `hotspotGuid1`, `hotspotGuid2`
        - `Src/DimensionHelper.cpp` - привязка к hotspot элементам (API_HotspotID)
        - `Src/DimensionCommands.cpp` - передача hotspot GUID в CreateLinearDimension
        - `DimensionGH_Gh/Components/DimCreateDimensionComponent.cs` - логика Update режима
